
{% extends 'base.html' %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h3 class="mb-0">Your Students</h3>
  <button class="btn btn-success" data-bs-toggle="collapse" data-bs-target="#addForm">+ Add Student</button>
</div>

<div id="addForm" class="collapse mb-4">
  <div class="card">
    <div class="card-body">
      <form method="post" action="{{ url_for('add_student') }}">
        <div class="row g-3">
          <div class="mb-3">
          <label class="form-label">Name</label>
            <input type="text" class="form-control" name="name" required>
          </div>
          <div class="mb-3">
          <label class="form-label">Age</label>
            <input type="number" class="form-control" name="age" min="0">
          </div>
          <div class="mb-3">
          <label class="form-label">Gender</label>
            <select class="form-select" name="gender">
              <option value="F">F</option>
              <option value="M">M</option>
            </select>
          </div>
          <div class="mb-3">
          <label class="form-label">Previous Marks</label>
            <input type="number" class="form-control" name="previous_marks" min="0" max="100">
          </div>
          <div class="mb-3">
          <label class="form-label">Attendance %</label>
            <input type="number" class="form-control" name="attendance_percent" step="0.01" min="0" max="100">
          </div>
          <div class="mb-3">
          <label class="form-label">Study hours / week</label>
            <input type="number" class="form-control" name="study_hours_per_week" min="0" max="168">
          </div>

          <div class="mb-3">
          <label class="form-label">Parental Education</label>
            <select class="form-select" name="parental_education">
              <option>Primary</option>
              <option>HighSchool</option>
              <option>Graduate</option>
              <option>PostGrad</option>
            </select>
          </div>
          <div class="mb-3">
          <label class="form-label">Family Income</label>
            <input type="number" class="form-control" name="family_income" min="0" step="1000">
          </div>
          <div class="mb-3">
          <label class="form-label">Internet Access</label>
            <select class="form-select" name="internet_access"><option>Yes</option><option>No</option></select>
          </div>
          <div class="mb-3">
          <label class="form-label">Extra Classes</label>
            <select class="form-select" name="extra_classes"><option>No</option><option>Yes</option></select>
          </div>

          <div class="mb-3">
          <label class="form-label">Assignment Score</label>
            <input type="number" class="form-control" name="assignment_score" step="0.01" min="0" max="100">
          </div>

        </div>
        <div class="mt-3">
          <button class="btn btn-primary">Save</button>
        </div>
      </form>
    </div>
  </div>
</div>

<div class="mb-2 d-flex align-items-center gap-2">
  <input id="searchInput" class="form-control" style="max-width:320px;" placeholder="Search by name...">
  <select id="resultFilter" class="form-select" style="max-width:180px;">
    <option value="">All</option>
    <option value="Pass">Pass only</option>
    <option value="Fail">Fail only</option>
  </select>
  <small class="text-muted ms-auto">Tip: click a header to sort</small>
</div>

<div class="card">
  <div class="card-body">
    <h5 class="card-title">Students</h5>
    <div class="table-responsive">
      <table class="table table-striped">
        <thead>
          <tr>
            <th data-sort="id">ID</th>
            <th data-sort="name">Name</th>
            <th data-sort="gender">Gender</th>
            <th data-sort="age">Age</th>
            <th data-sort="previous_marks">Previous Marks</th>
            <th data-sort="attendance_percent">Attendance %</th>
            <th data-sort="study_hours_per_week">Study Hours/Wk</th>
            <th data-sort="parental_education">Parent's Education</th>
            <th data-sort="family_income">Family Income</th>
            <th data-sort="internet_access">Internet Access</th>
            <th data-sort="extra_classes">Extra Classes</th>
            <th data-sort="assignment">Assignment Score</th>
            <th data-sort="prediction">Prediction</th>
            <th data-sort="probability">Probability</th>
            <th data-sort="action">Action</th>
          </tr>
        </thead>
        <tbody>
          {% for s in students %}
          <tr>
            <td><a href="{{ url_for('edit_student', student_id=s.id) }}">{{ s.id }}</a></td>
            <td>{{ s.name }}</td>
            <td>{{ s.gender or '' }}</td>
            <td>{{ s.age or '' }}</td>
            <td>{{ s.previous_marks or '' }}</td>
            <td>{{ s.attendance_percent or s.attendance or '' }}</td>
            <td>{{ s.study_hours_per_week or '' }}</td>
            <td>{{ s.parental_education or '' }}</td>
            <td>{{ s.family_income or '' }}</td>
            <td>{{ s.internet_access or '' }}</td>
            <td>{{ s.extra_classes or '' }}</td>
            <td>{{ s.assignment_score or '' }}</td>
            <td id="pred-{{ s.id }}">{{ s.prediction or '' }}</td>
            <td id="prob-{{ s.id }}">{{ (s.probability*100)|round(1) if s.probability is not none else '' }}</td>
            <td>
              <button class="btn btn-sm btn-outline-primary" onclick="predictStudent({{ s.id }})">Predict</button>
              <form action="{{ url_for('delete_student', student_id=s.id) }}" method="POST" style="display:inline;">
                <button type="submit" class="btn btn-sm btn-danger"
                        onclick="return confirm('Are you sure you want to delete this student?');">
                  Delete
                </button>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
<div class="mb-3 text-end">
  <button class="btn btn-sm btn-primary" onclick="predictAll()">Predict All</button>
</div>

<!-- Prediction Overview -->
<div class="row mt-4">
  <div class="col-md-6 d-flex justify-content-center">
    <div class="chart-container" style="max-width: 350px; max-height: 300px; margin: 20px auto;">
      <h5 class="text-center">Prediction Overview</h5>
      <div id="noDataMsg" class="text-center text-muted mt-2" style="display:none;">
        No predictions yet
      </div>
      <canvas id="predPie"></canvas>
    </div>
  </div>
  <div class="col-md-6">
    <div class="card shadow-sm">
      <div class="card-body">
        <h5 class="card-title">Prediction Summary</h5>
        <ul class="list-group">
          <li class="list-group-item d-flex justify-content-between">
            <span>Total Students</span> <strong>{{ total }}</strong>
          </li>
          <li class="list-group-item d-flex justify-content-between text-success">
            <span>Pass</span> <strong>{{ passes }}</strong>
          </li>
          <li class="list-group-item d-flex justify-content-between text-danger">
            <span>Fail</span> <strong>{{ fails }}</strong>
          </li>
          <li class="list-group-item d-flex justify-content-between">
            <span>Avg Pass Confidence</span> <strong>{{ avg_prob_pass*100 }}%</strong>
          </li>
          <li class="list-group-item d-flex justify-content-between">
            <span>Avg Fail Confidence</span> <strong>{{ avg_prob_fail*100 }}%</strong>
          </li>
        </ul>
      </div>
    </div>
  </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
async function loadStats() {
  try {
    const res = await fetch("/api/stats", { cache: "no-store" });
    const data = await res.json();

    const passes = Number(data.passes || 0);
    const fails = Number(data.fails || 0);

    // Show message if no data
    document.getElementById('noDataMsg').style.display = (passes + fails) === 0 ? 'block' : 'none';

    const ctx = document.getElementById('predPie').getContext('2d');
    if (window.__predChart) window.__predChart.destroy();

    window.__predChart = new Chart(ctx, {
      type: 'pie',
      data: {
        labels: ['Pass', 'Fail'],
        datasets: [{
          data: [passes, fails],
          backgroundColor: ['#4CAF50', '#F44336']
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: { legend: { position: 'bottom' } }
      }
    });
  } catch (e) {
    console.error("Failed to load stats", e);
  }
}

document.addEventListener('DOMContentLoaded', loadStats);
</script>
{% endblock %}
